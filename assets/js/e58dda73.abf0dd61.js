"use strict";(self.webpackChunkczertainly=self.webpackChunkczertainly||[]).push([[8727],{18262:function(e,n,t){t.r(n),t.d(n,{assets:function(){return o},contentTitle:function(){return c},default:function(){return u},frontMatter:function(){return s},metadata:function(){return a},toc:function(){return l}});var r=t(85893),i=t(11151);const s={},c="Kubernetes cert-manager",a={id:"certificate-key/protocols/acme/cert-manager",title:"Kubernetes cert-manager",description:"One of the most common use cases for ACME is to manage certificates for containerized applications and environment like Kubernetes.",source:"@site/docs/10-certificate-key/07-protocols/02-acme/11-cert-manager.md",sourceDirName:"10-certificate-key/07-protocols/02-acme",slug:"/certificate-key/protocols/acme/cert-manager",permalink:"/docs/certificate-key/protocols/acme/cert-manager",draft:!1,unlisted:!1,editUrl:"https://github.com/3KeyCompany/CZERTAINLY-Documentation/edit/documentation/docs/10-certificate-key/07-protocols/02-acme/11-cert-manager.md",tags:[],version:"current",sidebarPosition:11,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Enable ACME",permalink:"/docs/certificate-key/protocols/acme/enable-acme"},next:{title:"Certbot",permalink:"/docs/certificate-key/protocols/acme/certbot"}},o={},l=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Create new <code>ClusterIssuer</code>",id:"create-new-clusterissuer",level:2},{value:"Request certificate",id:"request-certificate",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"kubernetes-cert-manager",children:"Kubernetes cert-manager"}),"\n",(0,r.jsx)(n.p,{children:"One of the most common use cases for ACME is to manage certificates for containerized applications and environment like Kubernetes."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://cert-manager.io/",children:(0,r.jsx)(n.code,{children:"cert-manager"})})," adds certificates and certificate issuers as resource types in Kubernetes clusters, and simplifies the process of obtaining, renewing, and using those certificates. It can issue certificates from a variety of supported sources, including ACME compliant servers."]}),"\n",(0,r.jsxs)(n.p,{children:["For more information about ",(0,r.jsx)(n.code,{children:"cert-manager"}),", refer to the ",(0,r.jsx)(n.a,{href:"https://cert-manager.io/docs/",children:"cert-manager documentation"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["CZERTAINLY platform supports ACME implementation according to the ",(0,r.jsx)(n.a,{href:"https://datatracker.ietf.org/doc/html/rfc8555",children:"RFC 8555"}),". This guide shows, how you can use ",(0,r.jsx)(n.code,{children:"cert-manager"})," to manage certificates using ACME protocol and certificate management services controlled by the platform. In this combination, ",(0,r.jsx)(n.code,{children:"cert-manager"})," can manage certificates provided by literally any certification authority."]}),"\n",(0,r.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(n.p,{children:["Before you can configure ",(0,r.jsx)(n.code,{children:"cert-manager"})," with the CZERTAINLY, you need to have the following:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Kubernetes cluster with ",(0,r.jsx)(n.code,{children:"cert-manager"})," installed"]}),"\n",(0,r.jsxs)(n.li,{children:["Configured at least one ",(0,r.jsx)(n.code,{children:"RA Profile"})," certificate service"]}),"\n",(0,r.jsx)(n.li,{children:"Access to HTTP or DNS resources, that will be used to validate ACME challenges"}),"\n",(0,r.jsxs)(n.li,{children:["ACME protocol enabled according to the ",(0,r.jsx)(n.a,{href:"enable-acme",children:"Enable ACME"})]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["For this guide, we will use ",(0,r.jsx)(n.code,{children:"http-01"})," challenge validation, but the ",(0,r.jsx)(n.code,{children:"dns-01"})," can be also configured and the process is the same."]}),"\n",(0,r.jsxs)(n.p,{children:["In case you do not have the ",(0,r.jsx)(n.code,{children:"cert-manager"})," installed, follow the ",(0,r.jsx)(n.a,{href:"https://cert-manager.io/docs/installation/",children:"installation instructions"})," to install it."]}),"\n",(0,r.jsxs)(n.h2,{id:"create-new-clusterissuer",children:["Create new ",(0,r.jsx)(n.code,{children:"ClusterIssuer"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"ClusterIssuer"})," referencing our configured ACME service can be configured using the following manifest file:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"apiVersion: cert-manager.io/v1\nkind: ClusterIssuer\nmetadata:\n  name: clusterissuer-czertainly-acme\n  #namespace: default\nspec:\n  acme:\n    server: https://[domain]:[port]/api/v1/protocols/acme/raProfile/czertainly/directory\n    # Email address used for ACME registration\n    email: www@example.com\n    # Name of a secret used to store the ACME account private key\n    privateKeySecretRef:\n      name: issuer-czertainly-acme-secret\n    # Enable HTTP01 validations\n    solvers:\n    # An empty 'selector' means that this solver matches all domains\n    - selector: {}\n      http01:\n        ingress:\n          class: public\n"})}),"\n",(0,r.jsxs)(n.p,{children:["You should adjust this manifest according to your specific Kubernetes cluster. If the CZERTAINLY access point is using TLS certificate issued from private certification authority, you should include the CA certificate in ",(0,r.jsx)(n.code,{children:"cert-manager"})," configuration, otherwise it will reject communication."]}),"\n",(0,r.jsxs)(n.p,{children:["When you are ready, you can apply the manifest. This will start the communication with the ACME server and register the ACME client. You can check if the registration of ACME client was successful by ",(0,r.jsx)(n.a,{href:"/api/core-acme/#operation/listAcmeAccount",children:"listing all ACME Clients"})," in the platform and checking the state of the ",(0,r.jsx)(n.code,{children:"ClusterIssuer"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"kubectl describe -n cert-manager clusterissuers.cert-manager.io clusterissuer-czertainly-acme\n"})}),"\n",(0,r.jsxs)(n.p,{children:["You should see the status of the ",(0,r.jsx)(n.code,{children:"ClusterIssuer"})," indicating ",(0,r.jsx)(n.code,{children:"ACMEAccountRegistered"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"...\nStatus:\n  Acme:\n    Last Registered Email:  www@example.com\n    Uri:                    https://[domain]:[port]/api/v1/protocols/acme/cm/acct/KUAkYavhiMI\n  Conditions:\n    Last Transition Time:  2022-01-29T16:25:45Z\n    Message:               The ACME account was registered with the ACME server\n    Observed Generation:   1\n    Reason:                ACMEAccountRegistered\n    Status:                True\n    Type:                  Ready\nEvents:                    <none>\n"})}),"\n",(0,r.jsx)(n.p,{children:"That means that the ACME client was registered successfully, and you can start managing certificates."}),"\n",(0,r.jsx)(n.h2,{id:"request-certificate",children:"Request certificate"}),"\n",(0,r.jsx)(n.p,{children:"You can try to issue certificate using the following manifest:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"apiVersion: cert-manager.io/v1\nkind: Certificate\nmetadata:\n  name: cert-www-example-com\n  namespace: default\nspec:\n  secretName: cert-secret-www-example-com\n  renewBefore: 365h # 15d\n  issuerRef:\n    name: clusterissuer-czertainly-acme\n    kind: ClusterIssuer\n  commonName: www.example.com\n  dnsNames:\n  - www.example.com\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Applying this manifest in Kubernetes environment will start the ACME certificate issuing process. The brief steps what the ",(0,r.jsx)(n.code,{children:"cert-manager"})," will do are:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"generate new key pair and CSR, and store in the Secret"}),"\n",(0,r.jsx)(n.li,{children:"create Order resource in the ACME server"}),"\n",(0,r.jsx)(n.li,{children:"distribute the Challenge for validation"}),"\n",(0,r.jsx)(n.li,{children:"ask ACME server for the Challenge to be validated"}),"\n",(0,r.jsx)(n.li,{children:"sends the CSR to the ACME server to finalize"}),"\n",(0,r.jsx)(n.li,{children:"download the certificate from the ACME server"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"You can check the status of certificate resource in Kubernetes to see the result of the certificate issuing process:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"kubectl describe certificates.cert-manager.io cert-www-example-com\n"})}),"\n",(0,r.jsx)(n.p,{children:"When the certificate was issued and stored, you will see similar output:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"...\nStatus:\n  Conditions:\n    Last Transition Time:  2022-02-03T10:33:52Z\n    Message:               Certificate is up to date and has not expired\n    Observed Generation:   1\n    Reason:                Ready\n    Status:                True\n    Type:                  Ready\n  Not After:               2024-02-03T10:22:51Z\n  Not Before:              2022-02-03T10:22:51Z\n  Renewal Time:            2024-01-19T05:22:51Z\n  Revision:                1\nEvents:                    <none>\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The issued certificate is also included in the certificate inventory of the platform.\nFrom now on, the ",(0,r.jsx)(n.code,{children:"cert-manager"})," will renew the certificate automatically."]})]})}function u(e={}){const{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},11151:function(e,n,t){t.d(n,{Z:function(){return a},a:function(){return c}});var r=t(67294);const i={},s=r.createContext(i);function c(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);