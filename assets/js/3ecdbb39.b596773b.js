"use strict";(self.webpackChunkczertainly=self.webpackChunkczertainly||[]).push([[9945],{97639:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>c,metadata:()=>s,toc:()=>o});var i=t(85893),a=t(11151);const c={},r="Ansible acme module",s={id:"certificate-key/protocols/acme/ansible-acme",title:"Ansible acme module",description:"Ansible is a suite of tools to enable the automatization of software configuration. It can be used in conjunction with an ACME server running on the CZERTAINLY platform to automate certificate management, especially in situations where a target entity isn't capable of certificate management operations and direct communication with an ACME server through available ACME client implementations.",source:"@site/docs/10-certificate-key/07-protocols/02-acme/25-ansible-acme.md",sourceDirName:"10-certificate-key/07-protocols/02-acme",slug:"/certificate-key/protocols/acme/ansible-acme",permalink:"/docs/certificate-key/protocols/acme/ansible-acme",draft:!1,unlisted:!1,editUrl:"https://github.com/3KeyCompany/CZERTAINLY-Documentation/edit/documentation/docs/10-certificate-key/07-protocols/02-acme/25-ansible-acme.md",tags:[],version:"current",sidebarPosition:25,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Terraform acme provider",permalink:"/docs/certificate-key/protocols/acme/terraform"},next:{title:"Overview",permalink:"/docs/certificate-key/protocols/scep/overview"}},l={},o=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Steps",id:"steps",level:2},{value:"Ansible playbook preparation",id:"ansible-playbook-preparation",level:3},{value:"Register ACME account",id:"register-acme-account",level:3},{value:"Generate private key and prepare CSR",id:"generate-private-key-and-prepare-csr",level:3},{value:"Request verification challenge",id:"request-verification-challenge",level:3},{value:"Publishing verification challenge",id:"publishing-verification-challenge",level:3},{value:"Request validation",id:"request-validation",level:3},{value:"Delete validation challenges",id:"delete-validation-challenges",level:3},{value:"Issued certificate",id:"issued-certificate",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"ansible-acme-module",children:"Ansible acme module"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://www.ansible.com/",children:"Ansible"})," is a suite of tools to enable the automatization of software configuration. It can be used in conjunction with an ACME server running on the CZERTAINLY platform to automate certificate management, especially in situations where a target entity isn't capable of certificate management operations and direct communication with an ACME server through available ACME client implementations."]}),"\n",(0,i.jsxs)(n.p,{children:["CZERTAINLY platform supports ACME implementation according to the ",(0,i.jsx)(n.a,{href:"https://datatracker.ietf.org/doc/html/rfc8555",children:"RFC 8555"}),". This guide shows, how you can use Ansible ",(0,i.jsx)(n.code,{children:"acme"})," module to manage certificates using ACME protocol and certificate management services controlled by the platform."]}),"\n",(0,i.jsxs)(n.p,{children:["For more information about Ansible, refer to the ",(0,i.jsx)(n.a,{href:"https://docs.ansible.com/",children:"Ansible documentation"}),"."]}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsxs)(n.p,{children:["This guide assumes you have at least basic knowledge about Ansible. If you are new to Ansible, we recommend you to start with the ",(0,i.jsx)(n.a,{href:"https://docs.ansible.com/ansible/latest/getting_started/index.html",children:"Getting started with Ansible"}),"."]})}),"\n",(0,i.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsx)(n.p,{children:"To use Ansible with CZERTAINLY, you need to have the following:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Ansible installed"}),"\n",(0,i.jsxs)(n.li,{children:["Configured at least one ",(0,i.jsx)(n.code,{children:"RA Profile"})," certificate service in CZERTAINLY"]}),"\n",(0,i.jsx)(n.li,{children:"Access to HTTP or DNS resources that will be used to validate ACME challenges"}),"\n",(0,i.jsxs)(n.li,{children:["ACME protocol enabled according to the ",(0,i.jsx)(n.a,{href:"enable-acme",children:"Enable ACME"})]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["To install Ansible, follow the ",(0,i.jsx)(n.a,{href:"https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html",children:"installation instructions"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"steps",children:"Steps"}),"\n",(0,i.jsx)(n.p,{children:"To get a certificate with ACME protocol, you need to do several tasks typically using Ansible:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"register an account on the ACME server"}),"\n",(0,i.jsx)(n.li,{children:"prepare CSR to issue new certificate"}),"\n",(0,i.jsx)(n.li,{children:"request challenge on the ACME server"}),"\n",(0,i.jsx)(n.li,{children:"transport challenge data to HTTP or DNS server"}),"\n",(0,i.jsx)(n.li,{children:"request validation of the challenge on the ACME server"}),"\n",(0,i.jsx)(n.li,{children:"install the new certificate"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"ansible-playbook-preparation",children:"Ansible playbook preparation"}),"\n",(0,i.jsxs)(n.p,{children:["To demonstrate all steps, we will create a playbook file ",(0,i.jsx)(n.a,{href:"https://github.com/semik/ansible-acme-demo/blob/main/playbook-czertainly-acme-demo.yml",children:(0,i.jsx)(n.code,{children:"playbook-czertainly-acme-demo.yml"})}),"."]}),"\n",(0,i.jsx)(n.p,{children:"The playbook uses the following modules:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://docs.ansible.com/ansible/latest/collections/community/crypto/acme_account_module.html",children:(0,i.jsx)(n.code,{children:"community.crypto.acme_account"})})," for registration ACME account"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://docs.ansible.com/ansible/latest/collections/community/crypto/acme_certificate_module.html",children:(0,i.jsx)(n.code,{children:"community.crypto.acme_certificate"})})," for certificate management operations on ACME server"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://docs.ansible.com/ansible/latest/collections/community/crypto/openssl_privatekey_module.html",children:(0,i.jsx)(n.code,{children:"community.crypto.openssl_privatekey"})})," to generate unique key pair"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://docs.ansible.com/ansible/latest/collections/community/crypto/openssl_csr_module.html",children:(0,i.jsx)(n.code,{children:"community.crypto.openssl_csr"})})," to sign certificate signing request"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://docs.ansible.com/ansible/latest/collections/community/general/nsupdate_module.html",children:(0,i.jsx)(n.code,{children:"community.general.nsupdate"})})," to distribute ACME challenge to DNS server"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Even though Ansible community manages those modules, they are part of the standard Ansible packages."}),"\n",(0,i.jsxs)(n.p,{children:["At the beginning of the playbook file, we define default values that are used across tasks. The example playbook assumes that it is running on an HTTP server and that user running it has write permissions to ",(0,i.jsx)(n.code,{children:"/var/www/html"})," directory. All working files and resulting certificate is stored in the ",(0,i.jsx)(n.code,{children:"tmp"})," directory, which must be created before executing the playbook."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'- name: CZERTAINLY Ansible ACME example\n  hosts: localhost\n\n  tasks:\n    - name: Set vars\n      ansible.builtin.set_fact:\n        acme_directory: "https://[domain]:[port]/api/v1/protocols/acme/czertainly/directory"\n        acme_version: 2\n        acme_register_account: true\n        acme_web_dir: "/var/www/html"\n        acme_force: false\n        acme_account_email: "email@example.com"\n        bind: "{{ lookup(\'file\', \'vars/czertainly.private\') | from_yaml }}"\n\n    - name: Set default ACME method\n      ansible.builtin.set_fact:\n        acme_method: \'http-01\'\n        when: acme_method is not defined\n'})}),"\n",(0,i.jsx)(n.h3,{id:"register-acme-account",children:"Register ACME account"}),"\n",(0,i.jsx)(n.p,{children:"First, we will create private RSA key pair which will be associated with later registered account. The key can be used for revoking the issued certificate even when the private key of the certificate isn't available."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'    - name: Generate private key for ACME account\n      community.crypto.openssl_privatekey:\n        path: "tmp/acme_account_key"\n        type: RSA\n        size: 2048\n        mode: 0600\n\n    - name: Register ACME Account without external binding\n      community.crypto.acme_account:\n        account_key_src: "tmp/acme_account_key"\n        acme_directory: "{{ acme_directory }}"\n        acme_version: "{{ acme_version }}"\n        state: present\n        terms_agreed: true\n        contact:\n          - "mailto:{{ acme_account_email }}"\n      register: acme_account\n      when: acme_register_account\n'})}),"\n",(0,i.jsx)(n.h3,{id:"generate-private-key-and-prepare-csr",children:"Generate private key and prepare CSR"}),"\n",(0,i.jsx)(n.p,{children:"The step to generate key pair and certificate signing request is optional. You can also you externally generated and signed certificate signing request."}),"\n",(0,i.jsx)(n.admonition,{title:"Account vs certificate key pair",type:"note",children:(0,i.jsx)(n.p,{children:"Note that this key pair is not associated with the ACME account key pair."})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'    - name: Generate private key for server\n      community.crypto.openssl_privatekey:\n        path: "tmp/{{ acme_domain }}.key"\n        type: RSA\n        size: 2048\n        mode: 0600\n\n    - name: Generate certificate signing request (CSR)\n      community.crypto.openssl_csr:\n        path: "tmp/{{ acme_domain }}.csr"\n        privatekey_path: "tmp/{{ acme_domain }}.key"\n        common_name: "{{ acme_domain }}"\n        subject_alt_name: "DNS:{{ acme_domain }}"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"request-verification-challenge",children:"Request verification challenge"}),"\n",(0,i.jsxs)(n.p,{children:["Now, we need to submit the certificate signing request to ACME server and register validation challenge.. The argument ",(0,i.jsx)(n.code,{children:"dest"})," can be pointing to a non-existent file. But if it points to an existing certificate, the Ansible will check if it is below the default value 10 days and request renewal instead of new certificate (default behaviour). This can be modified by arguments ",(0,i.jsx)(n.code,{children:"remaining_days"})," and ",(0,i.jsx)(n.code,{children:"force"}),". The second argument, ",(0,i.jsx)(n.code,{children:"force"})," requests new certificate every time the playbook is executed, instead of checking for renewal."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'    - name: Create a challenge\n      community.crypto.acme_certificate:\n        account_key_src: "tmp/acme_account_key"\n        account_email: "{{ acme_account_email }}"\n        csr: "tmp/{{ acme_domain }}.csr"\n        dest: "tmp/{{ acme_domain }}}.crt"\n        acme_directory: "{{ acme_directory }}"\n        acme_version: "{{ acme_version }}"\n        terms_agreed: true\n        force: "{{ acme_force }}"\n        modify_account: false\n        challenge: "{{ acme_method }}"\n      register: acme_challenge\n\n    - name: Show challenge\n      ansible.builtin.debug: var=acme_challenge\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The following is an example of challenge data generated by CZERTAINLY for submitted CSR containing with two domain name identifiers ",(0,i.jsx)(n.code,{children:"demo.czertainly.test"})," and ",(0,i.jsx)(n.code,{children:"www.czertainly.test"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'  "challenge_data": {\n     "demo.czertainly.test": {\n        "dns-01": {\n           "record": "_acme-challenge.demo.czertainly.test",\n           "resource": "_acme-challenge",\n           "resource_value": "A1RnPLUigrrhd32tDtnF3yH_mgmuDLIfxKvBVrWefs4"\n        },\n        "http-01": {\n           "resource": ".well-known/acme-challenge/wXKY9aI5ChnUFGgUzG-dUDe85-Grq4Ub1MGZ2cYVtL4",\n           "resource_value": "wXKY9aI5ChnUFGgUzG-dUDe85-Grq4Ub1MGZ2cYVtL4.YS1M_PeBjPbe78-TEhNKOWuckVy7xf04IG0HpKijyPw"\n        },\n     },\n     "www.czertainly.test": {\n        "dns-01": {\n           "record": "_acme-challenge.www.czertainly.test",\n           "resource": "_acme-challenge",\n           "resource_value": "_UuzUAyxd1tFA3qx8k94HLmbLwV1Hsoqgef3YxhkWss"\n        },\n        "http-01": {\n           "resource": ".well-known/acme-challenge/OSu7SStl_kwYUOQ1dg0jzptGuaHf5VVcPiJyt-8oUMA",\n           "resource_value": "OSu7SStl_kwYUOQ1dg0jzptGuaHf5VVcPiJyt-8oUMA.YS1M_PeBjPbe78-TEhNKOWuckVy7xf04IG0HpKijyPw"\n        },\n     }\n  }\n'})}),"\n",(0,i.jsx)(n.h3,{id:"publishing-verification-challenge",children:"Publishing verification challenge"}),"\n",(0,i.jsxs)(n.p,{children:["In case you decide to use ",(0,i.jsx)(n.code,{children:"http-01"})," challenge validation method, you need to publish generated challenge in ",(0,i.jsx)(n.code,{children:"/var/www/html/.well-known/acme-challenge/"})," directory of the web server:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"    - name: Copy http-01 challenge data\n      ansible.builtin.copy:\n        dest: \"{{ acme_web_dir }}/{{ item.value['http-01']['resource'] }}\"\n        content: \"{{ item.value['http-01']['resource_value'] }}\"\n      with_dict:\n        - \"{{ acme_challenge['challenge_data'] }}\"\n      when: acme_method == 'http-01'\n"})}),"\n",(0,i.jsx)(n.admonition,{title:"Multiple identifiers",type:"note",children:(0,i.jsxs)(n.p,{children:["Note a loop using ",(0,i.jsx)(n.code,{children:"with_dict"})," to iterate over all identifiers."]})}),"\n",(0,i.jsxs)(n.p,{children:["In case you decide to use ",(0,i.jsx)(n.code,{children:"dns-01"})," challenge validation method, you need to publish TXT record to the DNS server responsible for the respective domain. Typically, access is granted based on the secret key that needs to be configured to sign request to write DNS records. Put your DNS credentials into file ",(0,i.jsx)(n.code,{children:"vars/czertainly.private"})," with the following content:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'server: 123.123.123.123\nkey_algorithm: "hmac-sha512"\nkey_name: "name"\nkey_secret: "base64 data of secret"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The file ",(0,i.jsx)(n.code,{children:"vars/czertainly.private"})," gets loaded every time the playbook is executed. The following Ansible task is responsible for publishing the challenge to desired DNS resolver:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'      community.general.nsupdate:\n        key_algorithm: "{{ bind.key_algorithm }}"\n        key_name: "{{ bind.key_name }}"\n        key_secret: "{{ bind.key_secret }}"\n        server: "{{ bind.server }}"\n        record: "{{ item.value[\'dns-01\'][\'record\'] }}."\n        type: "TXT"\n        value: "{{ item.value[\'dns-01\'][\'resource_value\'] | regex_replace(\'^(.*)$\', \'\\"\\\\1\\"\') }}"\n        state: present\n      with_dict:\n        - "{{ acme_challenge[\'challenge_data\'] }}"\n      when: acme_method == \'dns-01\'\n'})}),"\n",(0,i.jsx)(n.admonition,{title:"DNS dot notation",type:"note",children:(0,i.jsxs)(n.p,{children:["Note dot ",(0,i.jsx)(n.code,{children:"."})," after ",(0,i.jsx)(n.code,{children:"record"})," (DNS name) - it is required for some DNS server implementations, for example Bind9."]})}),"\n",(0,i.jsx)(n.h3,{id:"request-validation",children:"Request validation"}),"\n",(0,i.jsx)(n.p,{children:"Once the challenges are successfully published, Ansible can request CZERTAINLY to validate them:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'    - name: Let the challenge(s) be validated and retrieve the cert and intermediate certificate\n      community.crypto.acme_certificate:\n        account_key_src: "tmp/acme_account_key"\n        csr: "tmp/{{ acme_domain }}.csr"\n        dest: "tmp/{{ acme_domain }}.crt"\n        fullchain_dest: "tmp/{{ acme_domain }}-fullchain.crt"\n        chain_dest: "tmp/{{ acme_domain }}-intermediate.crt"\n        data: "{{ acme_challenge }}"\n        acme_directory: "{{ acme_directory }}"\n        acme_version: "{{ acme_version }}"\n        terms_agreed: true\n        force: "{{ acme_force }}"\n        modify_account: false\n        challenge: "{{ acme_method }}"\n      async: 120\n'})}),"\n",(0,i.jsxs)(n.p,{children:["This tasks is blocking and can take be time-consuming depending on how many challenges and how often are validated. Therefore, it is a good practice to set timeout for this task. With ",(0,i.jsx)(n.code,{children:"async: 120"}),", Ansible will wait for 2 minutes for challenge validation, and if it is not done even after this timeout, it will fail with an error."]}),"\n",(0,i.jsx)(n.h3,{id:"delete-validation-challenges",children:"Delete validation challenges"}),"\n",(0,i.jsx)(n.p,{children:"After successful challenge validation and obtaining issued certificate, we are going to do the cleanup:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'    - name: Clean http-01 challenge data from drive\n      ansible.builtin.file:\n        path: "{{ acme_web_dir }}/{{ item.value[\'http-01\'].resource }}"\n        state: absent\n      with_dict:\n        - "{{ acme_challenge[\'challenge_data\'] }}"\n      when: acme_method == \'http-01\'\n\n    - name: Clean dns-01 challenge data from DNS\n      community.general.nsupdate:\n        key_algorithm: "{{ bind.key_algorithm }}"\n        key_name: "{{ bind.key_name }}"\n        key_secret: "{{ bind.key_secret }}"\n        server: "{{ bind.server }}"\n        record: "{{ item.value[\'dns-01\'].record }}."\n        type: "TXT"\n        state: absent\n      with_dict:\n        - "{{ acme_challenge[\'challenge_data\'] }}"\n      when: acme_method == \'dns-01\'\n'})}),"\n",(0,i.jsx)(n.h3,{id:"issued-certificate",children:"Issued certificate"}),"\n",(0,i.jsxs)(n.p,{children:["The issued certificate is placed into file ",(0,i.jsx)(n.code,{children:'"tmp/{{ acme_domain }}.crt"'}),". Placing it in the right location is specific and different for various end entities. This is out of the scope of this guide."]})]})}function h(e={}){const{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},11151:(e,n,t)=>{t.d(n,{Z:()=>s,a:()=>r});var i=t(67294);const a={},c=i.createContext(a);function r(e){const n=i.useContext(c);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),i.createElement(c.Provider,{value:n},e.children)}}}]);