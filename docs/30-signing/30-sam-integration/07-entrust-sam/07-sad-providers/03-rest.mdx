import {Fragment} from "react";

# REST SAD Provider

The implementation class of the REST SAD Provider is:

```
com.czertainly.signserver.module.entrustsam.sad.RestSAMSadProvider
```

The following properties can be configured for the REST SAD Provider:

export const data = [
    {
        property: "SAD_PROVIDER_URL",
        description:
            (
                <>
                    URL to get the Signature Activation Data. The URL should implement REST interface of this provider.
                </>
            ),
        default:
            (
                <>
                    <span class="badge badge--secondary">NONE</span>
                </>
            ),
        mandatory:
            (
                <>
                    <span class="badge badge--success">YES</span>
                </>
            )
    },
    {
        property: "SAD_PROVIDER_AUTH_TYPE",
        description:
            (
                <>
                    Authorization type for the REST API. Supported values are:
                    <ul>
                        <li>NONE</li>
                        <li>BASIC</li>
                        <li>TLS</li>
                    </ul>
                    See information about the authentication properties below.
                </>
            ),
        default:
            (
                <>
                    <span class="badge badge--secondary">NONE</span>
                </>
            ),
        mandatory:
            (
                <>
                    <span class="badge badge--success">YES</span>
                </>
            )
    },
    {
        property: "SAD_PROVIDER_RESPONSE_TIMEOUT",
        description:
            (
                <>
                    Response timeout in seconds.
                </>
            ),
        default:
            (
                <>
                    <span class="badge badge--secondary">60</span>
                </>
            ),
        mandatory:
            (
                <>
                    <span class="badge badge--danger">NO</span>
                </>
            )
    }
];

export const GenTable = ({data}) => (
    <Fragment>
        {data.map((dat, i) =>{
            return(
                <tr key={i}>
                    <td><b>{dat.property}</b></td>
                    <td>{dat.description}</td>
                    <td>{dat.default}</td>
                    <td>{dat.mandatory}</td>
                </tr>)
        })}
    </Fragment>
);

<table>
    <th>Property</th>
    <th>Description</th>
    <th>Default Value</th>
    <th>Mandatory</th>
    <tbody>
    <GenTable data={data}/>
    </tbody>
</table>

## Authorization types

### BASIC

`SAP_PROVIDER_AUTH_TYPE = BASIC` needs additional properties to be configured, in particular:

export const basic = [
    {
        property: "SAD_PROVIDER_USERNAME",
        description:
            (
                <>
                    Identification of the user.
                </>
            ),
        default:
            (
                <>
                    <span class="badge badge--secondary">NONE</span>
                </>
            ),
        mandatory:
            (
                <>
                    Mandatory for <b>SAD_PROVIDER_AUTH_TYPE = BASIC</b>
                </>
            )
    },
    {
        property: "SAD_PROVIDER_PASSWORD",
        description:
            (
                <>
                    Password for the username.
                </>
            ),
        default:
            (
                <>
                    <span class="badge badge--secondary">NONE</span>
                </>
            ),
        mandatory:
            (
                <>
                    Mandatory for <b>SAD_PROVIDER_AUTH_TYPE = BASIC</b>
                </>
            )
    },
    {
        property: "SAD_PROVIDER_ENABLE_PREEMPTIVE_AUTH",
        description:
            (
                <>
                    Enable preemptive authentication. If enabled, the client will send the authentication header without receiving a challenge from the server.
                </>
            ),
        default:
            (
                <>
                    <span class="badge badge--secondary">false</span>
                </>
            ),
        mandatory:
            (
                <>
                    <span class="badge badge--danger">NO</span>
                </>
            )
    }
];

<table>
    <th>Property</th>
    <th>Description</th>
    <th>Default Value</th>
    <th>Mandatory</th>
    <tbody>
    <GenTable data={basic}/>
    </tbody>
</table>

### TLS

`SAP_PROVIDER_AUTH_TYPE = TLS` authenticates based on client certificate provided and server identity (TLS mutual authentication). The following options are available for the configuration of `TLS` authentication:

export const tls = [
    {
        property: "SAD_PROVIDER_KEYSTORE_FORMAT",
        description:
            (
                <>
                    Format of the keystore provided. Supported values are:
                    <ul>
                        <li>CRYPTOTOKEN</li>
                        <li>BASE64</li>
                        <li>FILE</li>
                    </ul>
                </>
            ),
        default:
            (
                <>
                    <span class="badge badge--secondary">NONE</span>
                </>
            ),
        mandatory:
            (
                <>
                    Mandatory for <b>SAD_PROVIDER_AUTH_TYPE = TLS</b>
                </>
            )
    },
    {
        property: "SAD_PROVIDER_KEYSTORE_ALIAS",
        description:
            (
                <>
                    Alias of the private key stored in the keystore.
                </>
            ),
        default:
            (
                <>
                    <span class="badge badge--secondary">NONE</span>
                </>
            ),
        mandatory:
            (
                <>
                    Mandatory for <b>SAD_PROVIDER_AUTH_TYPE = TLS</b>
                </>
            )
    },
    {
        property: "SAD_PROVIDER_KEYSTORE_INDEX",
        description:
            (
                <>
                    Index of the Crypto Token that is configured in <b>OTHER_SIGNERS</b> property.
                </>
            ),
        default:
            (
                <>
                    <span class="badge badge--secondary">NONE</span>
                </>
            ),
        mandatory:
            (
                <>
                    Mandatory for <b>SAD_PROVIDER_KEYSTORE_FORMAT = CRYPTOTOKEN</b>
                </>
            )
    },
    {
        property: "SAD_PROVIDER_KEYSTORE",
        description:
            (
                <>
                    Referring to the keystore content. See <a href="#keystore-formats">Keystore formats</a>.
                </>
            ),
        default:
            (
                <>
                    <span class="badge badge--secondary">NONE</span>
                </>
            ),
        mandatory:
            (
                <>
                    Mandatory for <b>SAD_PROVIDER_KEYSTORE_FORMAT = BASE64, FILE</b>
                </>
            )
    },
    {
        property: "SAD_PROVIDER_KEYSTORE_TYPE",
        description:
            (
                <>
                    Type of the keystore. Supported values are:
                    <ul>
                        <li>PKCS12</li>
                        <li>JKS</li>
                    </ul>
                </>
            ),
        default:
            (
                <>
                    <span class="badge badge--secondary">NONE</span>
                </>
            ),
        mandatory:
            (
                <>
                    Mandatory for <b>SAD_PROVIDER_KEYSTORE_FORMAT = BASE64, FILE</b>
                </>
            )
    },
    {
        property: "SAD_PROVIDER_KEYSTORE_PASSWORD",
        description:
            (
                <>
                    Password for the keystore.
                </>
            ),
        default:
            (
                <>
                    <span class="badge badge--secondary">NONE</span>
                </>
            ),
        mandatory:
            (
                <>
                    Mandatory for <b>SAD_PROVIDER_KEYSTORE_FORMAT = BASE64, FILE</b>
                </>
            )
    },
    {
        property: "SAD_PROVIDER_TRUSTSTORE",
        description:
            (
                <>
                    Referring to the truststore content. See <a href="#truststore-formats">Truststore formats</a>.
                </>
            ),
        default:
            (
                <>
                    <span class="badge badge--secondary">NONE</span>
                </>
            ),
        mandatory:
            (
                <>
                    <span class="badge badge--danger">NO</span>
                </>
            )
    },
    {
        property: "SAD_PROVIDER_TRUSTSTORE_FORMAT",
        description:
            (
                <>
                    Format of the truststore provided. Supported values are:
                    <ul>
                        <li>PEM</li>
                        <li>BASE64</li>
                        <li>FILE</li>
                    </ul>
                </>
            ),
        default:
            (
                <>
                    <span class="badge badge--secondary">NONE</span>
                </>
            ),
        mandatory:
            (
                <>
                    Mandatory when <b>SAD_PROVIDER_TRUSTSTORE</b> provided
                </>
            )
    },
    {
        property: "SAD_PROVIDER_TRUSTSTORE_TYPE",
        description:
            (
                <>
                    Type of the truststore. Supported values are:
                    <ul>
                        <li>PKCS12</li>
                        <li>JKS</li>
                    </ul>
                </>
            ),
        default:
            (
                <>
                    <span class="badge badge--secondary">NONE</span>
                </>
            ),
        mandatory:
            (
                <>
                    Mandatory for <b>SAD_PROVIDER_TRUSTSTORE_FORMAT = BASE64, FILE</b>
                </>
            )
    },
    {
        property: "SAD_PROVIDER_TRUSTSTORE_PASSWORD",
        description:
            (
                <>
                    Password for the truststore.
                </>
            ),
        default:
            (
                <>
                    <span class="badge badge--secondary">NONE</span>
                </>
            ),
        mandatory:
            (
                <>
                    Mandatory for <b>SAD_PROVIDER_TRUSTSTORE_FORMAT = BASE64, FILE</b>
                </>
            )
    },
];

<table>
    <th>Property</th>
    <th>Description</th>
    <th>Default Value</th>
    <th>Mandatory</th>
    <tbody>
    <GenTable data={tls}/>
    </tbody>
</table>

#### Keystore formats

The supported values for `SAD_PROVIDER_KEYSTORE_FORMAT` are defined as:
- **`CRYPTOTOKEN`** - the keystore is provided as reference to other Crypto Token defined in the SignServer. It must be part of the `OTHER_SIGNERS` property
- **`BASE64`** - The keystore is provided as Base64-encoded value that is part of the `SAD_PROVIDER_KEYSTORE` property
- **`FILE`** - The keystore is loaded from the filesystem and the absolute path for the keystore is expected to be provided as part of the `SAD_PROVIDER_KEYSTORE` property

#### Truststore formats

The supported values for `SAD_PROVIDER_TRUSTSTORE_FORMAT` are defined as:
- **`PEM`** - the truststore is provided as list of PEM-encoded certificates to be used as a trusted sources and is expected to be provided as part of the `SAD_PROVIDER_TRUSTSTORE` property
- **`BASE64`** - The truststore is provided as Base64-encoded value that is part of the `SAD_PROVIDER_TRUSTSTORE` property
- **`FILE`** - The keystore is loaded from the filesystem and the absolute path for the keystore is expected to be provided as part of the `SAD_PROVIDER_TRUSTSTORE` property

## OpenAPI Definition

:::warning
`v2` implementation of the OpenAPI definition is mandatory to use batch signing. See [Batch Signing](../../../ades-formats/batch-signing) for more information.
:::

### v1

```yaml
openapi: 3.0.3
info:
  title: REST Signature SAP Provider
  version: v1
paths:
  /v1/sad/buildSad:
    post:
      operationId: buildSad
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BuildSadRequestDTO'
        required: true
      responses:
        "200":
          description: OK
          content:
            '*/*':
              schema:
                $ref: '#/components/schemas/BuildSadResponseDTO'
components:
  schemas:
    BuildSadRequestDTO:
      type: object
      properties:
        userId:
          type: string
        keyId:
          type: string
        dtbs:
          type: string
        metadata:
          type: object
          additionalProperties:
            type: string
    BuildSadResponseDTO:
      type: object
      properties:
        sad:
          type: string
```

### v2

v2 API supports building Signature Activation Data for multiple data to be signed. It is mandatory to implement to support batch signing.
See [Batch Signing](../../../ades-formats/batch-signing) for more information.

```yaml
openapi: 3.0.3
info:
  title: REST Signature SAP Provider
  version: v1
paths:
  /v2/sad/buildSad:
    post:
      operationId: buildSad
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BuildSadRequestDTO'
        required: true
      responses:
        "200":
          description: OK
          content:
            '*/*':
              schema:
                $ref: '#/components/schemas/BuildSadResponseDTO'
components:
  schemas:
    BuildSadRequestDTO:
      type: object
      properties:
        userId:
          type: string
        keyId:
          type: string
        dtbs:
          type: array
          items:
            type: string
        metadata:
          type: object
          additionalProperties:
            type: string
    BuildSadResponseDTO:
      type: object
      properties:
        sad:
          type: string
```